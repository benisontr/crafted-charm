<%- include('./partials/header') %>

<div class="wrapper">
  <div class="page-content">
    <div class="container-xxl mt-4">
      <div class="card shadow-sm p-4 border rounded-4 bg-white">

        <!-- Order Info -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 pb-3">
          <div class="mb-3 mb-md-0">
            <h3 class="mb-1 fw-bold text-primary">Order #<%= order.orderId %></h3>
            <p class="text-muted mb-0"><i class="bi bi-calendar me-2"></i>Placed on <%= order.createdAt.toDateString() %></p>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 d-flex align-items-center">
              <i class="bi bi-check-circle-fill me-2"></i>Paid
            </span>
            <span class="badge bg-warning bg-opacity-10 text-warning px-3 py-2 d-flex align-items-center">
              <i class="bi bi-truck me-2"></i><%= order.status %>
            </span>
          </div>
        </div>

        <!-- Order Timeline -->
        <div class="mb-5">
          <h5 class="fw-bold mb-3 text-secondary">Order Timeline</h5>
          <div class="timeline-wrapper">
            <!-- Packing Started -->
            <div class="timeline-card">
              <div class="timeline-content">
                <div class="timeline-header">
                  <h6 class="fw-semibold mb-1">The packing has been started</h6>
                  <small class="text-muted">April 23, 2024, 09:40 am</small>
                </div>
                <p class="text-muted small mb-2">Confirmed by Gaston Lapierre</p>
              </div>
              <div class="timeline-badge bg-success">
                <i class="bi bi-box-seam"></i>
              </div>
            </div>

            <!-- Invoice Sent -->
            <div class="timeline-card">
              <div class="timeline-content">
                <div class="timeline-header">
                  <h6 class="fw-semibold mb-1">The invoice has been sent to the customer</h6>
                  <small class="text-muted">April 23, 2024, 09:40 am</small>
                </div>
                <p class="text-muted small mb-2">Invoice email sent to hello@dundermufflin.com</p>
                <button class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-send me-1"></i>Resend Invoice
                </button>
              </div>
              <div class="timeline-badge bg-info">
                <i class="bi bi-envelope-paper"></i>
              </div>
            </div>

            <!-- Invoice Created -->
            <div class="timeline-card">
              <div class="timeline-content">
                <div class="timeline-header">
                  <h6 class="fw-semibold mb-1">The invoice has been created</h6>
                  <small class="text-muted">April 23, 2024, 09:40 am</small>
                </div>
                <p class="text-muted small mb-2">Invoice created by Gaston Lapierre</p>
                <button class="btn btn-sm btn-warning">
                  <i class="bi bi-download me-1"></i>Download Invoice
                </button>
              </div>
              <div class="timeline-badge bg-primary">
                <i class="bi bi-file-earmark-text"></i>
              </div>
            </div>

            <!-- Payment Done -->
            <div class="timeline-card">
              <div class="timeline-content">
                <div class="timeline-header">
                  <h6 class="fw-semibold mb-1">Order Payment</h6>
                  <small class="text-muted">April 23, 2024, 09:40 am</small>
                </div>
                <p class="text-muted small mb-2">Using MasterCard</p>
                <span class="badge bg-success bg-opacity-10 text-success">Paid</span>
              </div>
              <div class="timeline-badge bg-success">
                <i class="bi bi-credit-card"></i>
              </div>
            </div>

            <!-- Order Confirmed -->
            <div class="timeline-card">
              <div class="timeline-content">
                <div class="timeline-header">
                  <h6 class="fw-semibold mb-1">Order Confirmed</h6>
                  <small class="text-muted">April 23, 2024, 09:40 am</small>
                </div>
                <p class="text-muted small mb-2">4 Orders confirmed by Gaston Lapierre</p>
                <div class="d-flex flex-wrap gap-1">
                  <span class="badge bg-light border text-dark">Order 1</span>
                  <span class="badge bg-light border text-dark">Order 2</span>
                  <span class="badge bg-light border text-dark">Order 3</span>
                  <span class="badge bg-light border text-dark">Order 4</span>
                </div>
              </div>
              <div class="timeline-badge bg-primary">
                <i class="bi bi-check-circle"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Status Tracker -->
        <div class="mb-5">
          <h5 class="fw-bold mb-3 text-secondary">Delivery Status</h5>
          <div class="delivery-tracker">
            <% const steps = [
              { name: 'Confirmed', icon: 'bi-check-circle' },
              { name: 'Processed', icon: 'bi-gear' },
              { name: 'Shipped', icon: 'bi-truck' },
              { name: 'Delivered', icon: 'bi-house-check' }
            ]; %>
            <% steps.forEach((step, i) => { %>
              <div class="tracker-step <%= steps.indexOf(step) <= steps.findIndex(s => s.name === order.status) ? 'active' : '' %>">
                <div class="step-icon">
                  <i class="bi <%= step.icon %>"></i>
                </div>
                <div class="step-label"><%= step.name %></div>
                <% if (i !== steps.length - 1) { %>
                  <div class="step-connector"></div>
                <% } %>
              </div>
            <% }); %>
          </div>
        </div>

        <!-- Product Items -->
        <div class="mb-5">
          <h5 class="fw-bold mb-3 text-secondary">Ordered Products</h5>
          <div class="row g-3">
            <% order.items.forEach(item => { %>
              <div class="col-12">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <img src="<%= item.productId?.thumbnail || '/images/default.jpg' %>" class="rounded-3 me-4" width="80" height="80" alt="Product">
                      <div class="flex-grow-1">
                        <h6 class="mb-1 fw-semibold"><%= item.productId?.name || 'Product Name' %></h6>
                        <p class="mb-1 text-muted small">Product ID: <%= item.productId?._id || 'N/A' %></p>
                        <div class="d-flex flex-wrap gap-3">
                          <p class="mb-0">Quantity: <strong><%= item.quantity %></strong></p>
                          <p class="mb-0">Amount: <strong>$<%= item.subtotal.toFixed(2) %></strong></p>
                        </div>
                      </div>
                      <div>
                        <span class="badge <%= item.status === 'Ready' ? 'bg-success bg-opacity-10 text-success' : 'bg-secondary bg-opacity-10 text-secondary' %> px-3 py-2">
                          <i class="bi <%= item.status === 'Ready' ? 'bi-check-circle' : 'bi-hourglass' %> me-1"></i><%= item.status %>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        </div>

        <!-- Customer & Order Summary -->
        <div class="row g-4 mb-4">
          <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <h5 class="fw-bold mb-3 text-secondary">Customer Details</h5>
                <div class="customer-details">
                  <div class="detail-item">
                    <i class="bi bi-person text-primary"></i>
                    <div>
                      <span class="text-muted">Name:</span>
                      <span><%= order.userId.name %></span>
                    </div>
                  </div>
                  <div class="detail-item">
                    <i class="bi bi-envelope text-primary"></i>
                    <div>
                      <span class="text-muted">Email:</span>
                      <span><%= order.userId.email %></span>
                    </div>
                  </div>
                  <div class="detail-item">
                    <i class="bi bi-telephone text-primary"></i>
                    <div>
                      <span class="text-muted">Phone:</span>
                      <span><%= order.userId.phone %></span>
                    </div>
                  </div>
                  <div class="detail-item">
                    <i class="bi bi-geo-alt text-primary"></i>
                    <div>
                      <span class="text-muted">Shipping Address:</span>
                      <span>
                        <%= order.userId.address[0]?.shipping.addressLine %>, <%= order.userId.address[0]?.shipping.city %><br>
                        <%= order.userId.address[0]?.shipping.state %>, <%= order.userId.address[0]?.shipping.country %> - <%= order.userId.address[0]?.shipping.pincode %>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <h5 class="fw-bold mb-3 text-secondary">Order Summary</h5>
                <div class="order-summary">
                  <div class="summary-item">
                    <span>Subtotal</span>
                    <span>$<%= order.subtotal?.toFixed(2) || '0.00' %></span>
                  </div>
                  <div class="summary-item">
                    <span>Discount</span>
                    <span class="text-danger">-$<%= order.discount?.toFixed(2) || '0.00' %></span>
                  </div>
                  <div class="summary-item">
                    <span>Tax</span>
                    <span>$<%= order.tax?.toFixed(2) || '0.00' %></span>
                  </div>
                  <div class="summary-item total">
                    <span>Total</span>
                    <span>$<%= order.total?.toFixed(2) || '0.00' %></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Info -->
        <div class="mb-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h5 class="fw-bold mb-3 text-secondary">Payment Information</h5>
              <div class="payment-info">
                <div class="payment-item">
                  <i class="bi bi-credit-card-2-front text-primary"></i>
                  <div>
                    <span class="text-muted">Method:</span>
                    <span><%= order.paymentMethod %></span>
                  </div>
                </div>
                <div class="payment-item">
                  <i class="bi bi-receipt text-primary"></i>
                  <div>
                    <span class="text-muted">Transaction ID:</span>
                    <span><%= order.transactionId %></span>
                  </div>
                </div>
                <div class="payment-item">
                  <i class="bi bi-person-badge text-primary"></i>
                  <div>
                    <span class="text-muted">Card Holder:</span>
                    <span><%= order.cardHolderName %></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Requests -->
        <% if (order.returnRequest || order.refundRequest) { %>
          <div class="mt-4">
            <h5 class="fw-bold mb-3 text-secondary">Customer Requests</h5>
            <% if (order.returnRequest) { %>
              <div class="alert alert-warning bg-opacity-10 border border-warning border-opacity-25 d-flex flex-column flex-md-row justify-content-between align-items-center shadow-sm">
                <div class="mb-2 mb-md-0">
                  <i class="bi bi-arrow-return-right me-2"></i>
                  <strong>Return Request:</strong> <%= order.returnRequest.reason %>
                </div>
                <div class="d-flex gap-2">
                  <form method="POST" action="/admin/order/<%= order._id %>/return/accept" class="d-inline">
                    <button class="btn btn-sm btn-success">
                      <i class="bi bi-check-circle me-1"></i>Accept
                    </button>
                  </form>
                  <form method="POST" action="/admin/order/<%= order._id %>/return/reject" class="d-inline">
                    <button class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-x-circle me-1"></i>Reject
                    </button>
                  </form>
                </div>
              </div>
            <% } %>
            <% if (order.refundRequest) { %>
              <div class="alert alert-danger bg-opacity-10 border border-danger border-opacity-25 d-flex flex-column flex-md-row justify-content-between align-items-center shadow-sm">
                <div class="mb-2 mb-md-0">
                  <i class="bi bi-currency-exchange me-2"></i>
                  <strong>Refund Request:</strong> <%= order.refundRequest.reason %>
                </div>
                <div class="d-flex gap-2">
                  <form method="POST" action="/admin/order/<%= order._id %>/refund/accept" class="d-inline">
                    <button class="btn btn-sm btn-success">
                      <i class="bi bi-check-circle me-1"></i>Accept
                    </button>
                  </form>
                  <form method="POST" action="/admin/order/<%= order._id %>/refund/reject" class="d-inline">
                    <button class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-x-circle me-1"></i>Reject
                    </button>
                  </form>
                </div>
              </div>
            <% } %>
          </div>
        <% } %>

      </div>
    </div>
  </div>

  <%- include('./partials/footer') %>
</div>

<!-- Custom Style -->
<style>
  :root {
    --primary-color: #4361ee;
    --secondary-color: #3f37c9;
    --success-color: #4cc9f0;
    --light-bg: #f8f9fa;
    --border-radius: 10px;
  }

  body {
    background-color: #f5f7fb;
  }

  .card {
    border-radius: var(--border-radius);
    border: none;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
  }

  /* Timeline Styles */
  .timeline-wrapper {
    position: relative;
    padding-left: 40px;
  }

  .timeline-card {
    position: relative;
    padding-bottom: 30px;
  }

  .timeline-card:last-child {
    padding-bottom: 0;
  }

  .timeline-content {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    position: relative;
  }

  .timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }

  .timeline-badge {
    position: absolute;
    left: -50px;
    top: 0;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
    box-shadow: 0 0 0 4px white;
  }

  .timeline-card::before {
    content: '';
    position: absolute;
    left: -32px;
    top: 36px;
    height: calc(100% - 36px);
    width: 2px;
    background: #e9ecef;
  }

  .timeline-card:last-child::before {
    display: none;
  }

  /* Delivery Tracker */
  .delivery-tracker {
    display: flex;
    justify-content: space-between;
    position: relative;
    padding: 20px 0;
  }

  .tracker-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    flex: 1;
  }

  .step-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px;
    color: #6c757d;
    font-size: 18px;
  }

  .step-label {
    font-size: 14px;
    color: #6c757d;
    text-align: center;
  }

  .step-connector {
    position: absolute;
    top: 20px;
    left: 60%;
    width: 80%;
    height: 2px;
    background-color: #e9ecef;
    z-index: -1;
  }

  .tracker-step.active .step-icon {
    background-color: var(--primary-color);
    color: white;
  }

  .tracker-step.active .step-label {
    color: var(--primary-color);
    font-weight: 500;
  }

  .tracker-step.active .step-connector {
    background-color: var(--primary-color);
    opacity: 0.3;
  }

  /* Customer Details */
  .customer-details {
    display: grid;
    gap: 16px;
  }

  .detail-item {
    display: flex;
    gap: 12px;
    align-items: flex-start;
  }

  .detail-item i {
    font-size: 18px;
    margin-top: 2px;
  }

  .detail-item div {
    display: flex;
    flex-direction: column;
  }

  .detail-item span:first-child {
    font-size: 13px;
    color: #6c757d;
  }

  /* Order Summary */
  .order-summary {
    display: grid;
    gap: 12px;
  }

  .summary-item {
    display: flex;
    justify-content: space-between;
    padding-bottom: 8px;
    border-bottom: 1px dashed #e9ecef;
  }

  .summary-item.total {
    padding-top: 8px;
    border-bottom: none;
    font-weight: bold;
    font-size: 18px;
  }

  /* Payment Info */
  .payment-info {
    display: grid;
    gap: 16px;
  }

  .payment-item {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .payment-item i {
    font-size: 18px;
  }

  .payment-item div {
    display: flex;
    flex-direction: column;
  }

  .payment-item span:first-child {
    font-size: 13px;
    color: #6c757d;
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .timeline-wrapper {
      padding-left: 30px;
    }
    
    .timeline-badge {
      left: -40px;
      width: 30px;
      height: 30px;
      font-size: 14px;
    }
    
    .delivery-tracker {
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .tracker-step {
      flex: 0 0 calc(50% - 20px);
      margin-bottom: 20px;
    }
    
    .step-connector {
      display: none;
    }
  }

  @media (max-width: 576px) {
    .tracker-step {
      flex: 0 0 100%;
    }
  }
</style>