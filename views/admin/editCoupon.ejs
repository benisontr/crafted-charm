<%- include('./partials/header') %>
<%- include('./partials/adminHeader') %>

<div class="wrapper">
  <%- include('./partials/sidebar') %>

  <div class="page-content">
    <div class="container-xxl">
      <div class="row">
        <div class="col-lg-12">
          <form id="couponForm">
            <div class="row">
              <!-- Coupon Status -->
            <div class="col-lg-5">
               <div class="card">
                  <div class="card-header">
                    <h4 class="card-title">Coupon Status</h4>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-lg-4">
  <div class="form-check">
    <input class="form-check-input" type="radio" name="status" value="Active" id="statusActive"
      <%= coupon.status === 'Active' ? 'checked' : '' %> >
    <label class="form-check-label" for="statusActive">Active</label>
  </div>
</div>
<div class="col-lg-4">
  <div class="form-check">
    <input class="form-check-input" type="radio" name="status" value="Inactive" id="statusInactive"
      <%= coupon.status === 'Inactive' ? 'checked' : '' %> >
    <label class="form-check-label" for="statusInactive">Inactive</label>
  </div>
</div>
<div class="col-lg-4">
  <div class="form-check">
    <input class="form-check-input" type="radio" name="status" value="Future Plan" id="statusFuture"
      <%= coupon.status === 'Future Plan' ? 'checked' : '' %> >
    <label class="form-check-label" for="statusFuture">Future Plan</label>
  </div>
</div>
</div>
</div>
</div>
  <!-- Date Schedule -->
  <div class="card">
                  <div class="card-header">
                    <h4 class="card-title">Date Schedule</h4>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label for="start-date" class="form-label text-dark">Start Date</label>
                      <input type="text" id="start-date" name="startDate" class="form-control" placeholder="dd-mm-yyyy" readonly>
                    </div>
                    <div class="mb-3">
                      <label for="end-date" class="form-label text-dark">End Date</label>
                      <input type="text" id="end-date" name="endDate" class="form-control" placeholder="dd-mm-yyyy" readonly>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Coupon Info -->
              <div class="col-lg-7">
                <div class="card">
                  <div class="card-header">
                    <h4 class="card-title">Coupon Information</h4>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <!-- Code -->
                      <div class="col-lg-6">
                        <div class="mb-3">
                          <label for="coupons-code" class="form-label" >Coupon Code</label>
                          <input type="text" id="coupons-code" name="code" class="form-control" value="<%= coupon.code %>">
                        </div>
                      </div>

                      <!-- Category -->
                        <div class="col-lg-6">
                        <div class="mb-3">
                            <label for="categoryId" class="form-label">Select Category</label>
                     <select id="categoryId" name="categoryId" class="form-select" required>
  <option value="">-- Choose a Category --</option>
  <% categories.forEach(category => { %>
    <option value="<%= category._id %>" <%= category._id.toString() === coupon.categoryId.toString() ? 'selected' : '' %>>
      <%= category.name %>
    </option>
  <% }) %>
</select>
</div>
</div>


                      <!-- Products -->
                      <div class="col-lg-6">
                        <div class="mb-3">
                          <label for="product-categories" class="form-label">Discount Product</label>
                          <select class="form-control" id="product-categories" name="productId">
                            <option value="">-- Select Category First --</option>
                          </select>
                        </div>
                      </div>
                    </div>

                    <!-- Discount Value -->
                    <div class="row">
                      <div class="col-lg-12">
                        <div class="mb-3">
                          <label for="discount-value" class="form-label">Discount Percentage</label>
                          <input type="number" id="discount-value" name="discountValue" class="form-control" placeholder="Enter value" value="<%= coupon.discountPercentage %>">
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Submit Button -->
                  <div class="card-footer border-top">
                    <button type="submit" class="btn btn-primary">Edit Coupon</button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('./partials/footer') %>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Date Picker Init -->
<script>
  flatpickr("#start-date", { dateFormat: "d-m-Y" });
  flatpickr("#end-date", { dateFormat: "d-m-Y" });
</script>

<!-- Load products dynamically by category -->
<script>
  document.getElementById('categoryId').addEventListener('change', function () {
    const categoryId = this.value;
    const productSelect = document.getElementById('product-categories');
    productSelect.innerHTML = '<option value="">Loading...</option>';

    if (categoryId) {
      fetch(`/admin/products/by-category/${categoryId}`)
        .then(res => res.json())
        .then(data => {
          productSelect.innerHTML = '<option value="">-- Select Product --</option>';
          data.products.forEach(product => {
            const option = document.createElement('option');
            option.value = product._id;
            option.textContent = product.name;
            productSelect.appendChild(option);
          });
        })
        .catch(err => {
          console.error(err);
          productSelect.innerHTML = '<option value="">Error loading products</option>';
        });
    }
  });
</script>

<!-- Form Submit Script -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const couponForm = document.getElementById("couponForm");
    const couponId = "<%= coupon._id %>"; // Pass coupon ID from server

    flatpickr("#start-date", {
      dateFormat: "d-m-Y",
      defaultDate: new Date("<%= coupon.startDate.toISOString() %>")
    });

    flatpickr("#end-date", {
      dateFormat: "d-m-Y",
      defaultDate: new Date("<%= coupon.endDate.toISOString() %>")
    });

    // Populate products dropdown with selected category's products
    const productSelect = document.getElementById("product-categories");
    const categoryId = document.getElementById("categoryId").value;

    if (categoryId) {
      fetch(`/admin/products/by-category/${categoryId}`)
        .then(res => res.json())
        .then(data => {
          productSelect.innerHTML = '<option value="">-- Select Product --</option>';
          data.products.forEach(product => {
            const selected = product._id === "<%= coupon.productId.toString() %>" ? 'selected' : '';
            productSelect.innerHTML += `<option value="${product._id}" ${selected}>${product.name}</option>`;
          });
        });
    }

    document.getElementById("categoryId").addEventListener("change", function () {
      const selectedCategory = this.value;
      productSelect.innerHTML = '<option value="">Loading...</option>';
      if (selectedCategory) {
        fetch(`/admin/products/by-category/${selectedCategory}`)
          .then(res => res.json())
          .then(data => {
            productSelect.innerHTML = '<option value="">-- Select Product --</option>';
            data.products.forEach(product => {
              const option = document.createElement('option');
              option.value = product._id;
              option.textContent = product.name;
              productSelect.appendChild(option);
            });
          });
      }
    });

    couponForm.addEventListener("submit", function (e) {
     
      e.preventDefault();


      const formData = {
        code: document.getElementById("coupons-code").value,
        categoryId: document.getElementById("categoryId").value,
        productId: document.getElementById("product-categories").value,
        discountValue: document.getElementById("discount-value").value,
        startDate: document.getElementById("start-date").value,
        endDate: document.getElementById("end-date").value,
        status: document.querySelector('input[name="status"]:checked').value
      };

      fetch(`/admin/edit-coupon?id=${couponId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("Coupon updated successfully!");
            window.location.href = "/admin/list-coupon";
          } else {
            alert("Failed to update coupon: " + data.message);
          }
        })
        .catch(err => {
          console.error(err);
          alert("Something went wrong while updating coupon.");
        });
    });
  });
</script>

