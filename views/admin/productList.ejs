<%- include('./partials/header') %>

<div class="wrapper">
  <%- include('./partials/adminHeader') %>
  <%- include('./partials/sidebar') %>

  <div class="page-content">
    <div class="container-fluid">

      <div class="row">
        <div class="col-xl-12">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center gap-1">
              <h4 class="card-title flex-grow-1">All Product List</h4>
              <a href="/admin/add-product" class="btn btn-sm btn-primary">Add Product</a>

              <div class="dropdown">
                <a href="#" class="dropdown-toggle btn btn-sm btn-outline-light" data-bs-toggle="dropdown" aria-expanded="false">
                  This Month
                </a>
                <div class="dropdown-menu dropdown-menu-end">
                  <a href="#!" class="dropdown-item">Download</a>
                  <a href="#!" class="dropdown-item">Export</a>
                  <a href="#!" class="dropdown-item">Import</a>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table align-middle mb-0 table-hover table-centered">
                <thead class="bg-light-subtle">
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Product Code</th>
                    <th>Price</th>
                    <th>Action</th>
                  </tr>
                </thead>

                <tbody>
                  <% if (products.length > 0) { %>
                    <% products.forEach(product => { %>
                      <tr>
                        <td>
                          <div class="d-flex align-items-center gap-2">
                            <div class="rounded bg-light avatar-md d-flex align-items-center justify-content-center">
                              <% if (product.images && product.images.length > 0) { %>
                                <img src="<%= product.images[0] %>" alt="Product Image" class="avatar-md">
                              <% } else { %>
                                <img src="assets/images/handlooms/sarees27.jpg" alt="Category Image" class="avatar-md" />
                              <% } %>
                            </div>
                            <div>
                              <a href="#!" class="text-dark fw-medium fs-15"><%= product.productId %></a>
                            </div>
                          </div>
                        </td>

                        <td><%= product.name %></td>
                        <td><%= product.categoryId.name %></td>
                        <td><%= product.productCode %></td>
                        <td><%= product.price %></td>

                        <td>
                          <div class="d-flex gap-2">
                            <a href="/admin/product-details?id=<%= product._id %>" class="btn btn-light btn-sm">
                              <iconify-icon icon="solar:eye-broken" class="align-middle fs-18"></iconify-icon>
                            </a>
                            <a href="/admin/edit-product?id=<%= product._id %>" class="btn btn-soft-primary btn-sm">
                              <iconify-icon icon="solar:pen-2-broken" class="align-middle fs-18"></iconify-icon>
                            </a>
                            <a href="#!" class="btn btn-soft-danger btn-sm delete-btn" data-id="<%= product._id %>">
                              <iconify-icon icon="solar:trash-bin-minimalistic-2-broken" class="align-middle fs-18"></iconify-icon>
                            </a>
                          </div>
                        </td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    <tr>
                      <td colspan="7" class="text-center">No products found</td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>

            <div class="card-footer border-top">
              <nav aria-label="Page navigation example">
                <ul class="pagination justify-content-end mb-0">
                  <li class="page-item"><a class="page-link" href="javascript:void(0);">Previous</a></li>
                  <li class="page-item active"><a class="page-link" href="javascript:void(0);">1</a></li>
                  <li class="page-item"><a class="page-link" href="javascript:void(0);">2</a></li>
                  <li class="page-item"><a class="page-link" href="javascript:void(0);">3</a></li>
                  <li class="page-item"><a class="page-link" href="javascript:void(0);">Next</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <%- include('./partials/footer') %>
</div>

<!-- Delete Product Script -->
<script>
  document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', async function () {
      const productId = this.getAttribute('data-id');

      if (confirm('Are you sure you want to delete this product?')) {
        try {
          const res = await fetch(`/admin/delete-product/${productId}`, {
            method: 'DELETE',
          });

          if (res.ok) {
            alert('Product deleted successfully!');
            location.reload();
          } else {
            const error = await res.json();
            alert('Failed to delete product: ' + error.message);
          }
        } catch (err) {
          console.error(err);
          alert('An error occurred while deleting.');
        }
      }
    });
  });
</script>
